<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AgriCheck – Inspektionspunkte Explorer</title>

    <!-- Bootstrap & Icons for quick styling -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- jsTree CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/jstree@3.3.12/dist/themes/default/style.min.css"
      rel="stylesheet"
    />

    <style>
      /* Keep the tree container height constrained and scrollable */
      #tree {
        max-height: 70vh;
        overflow: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1rem;
      }
      /* Optional: details panel styling */
      #details {
        min-height: 6rem;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <h1 class="mb-4">AgriCheck – Inspektionspunkte Explorer</h1>

      <!-- Search -->
      <div class="mb-3">
        <input
          id="search"
          class="form-control"
          type="search"
          placeholder="Suche nach Kontrollpunkt oder Gruppe…"
          aria-label="Suche"
        />
      </div>

      <!-- Tree -->
      <div id="tree" role="tree"></div>

      <!-- Details -->
      <div id="details" class="mt-4"></div>
    </div>

    <!-- Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jstree@3.3.12/dist/jstree.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunr/lunr.js"></script>

    <!-- Main logic -->
    <script type="module">
      const ENDPOINT = "https://lindas.admin.ch/query";

      const SPARQL_QUERY = `PREFIX :           <https://agriculture.ld.admin.ch/inspection/>
PREFIX dcterms:    <http://purl.org/dc/terms/>
PREFIX schema:     <http://schema.org/>
PREFIX rdfs:       <http://www.w3.org/2000/01/rdf-schema#>

SELECT
  ?s ?sType ?sLabel ?sComment ?hierarchyLevel
  ?subGroup ?subGroupLabel ?subGroupComment
  ?superGroup
  ?inspectionPoint ?inspectionPointLabel ?inspectionPointComment
  ?parentGroup
WHERE {
  ?s a ?sType .
  FILTER(?sType IN (dcterms:Collection, :InspectionPoint))

  OPTIONAL { ?s rdfs:label   ?sLabel   . FILTER(LANG(?sLabel)   = "de") }
  OPTIONAL { ?s rdfs:comment ?sComment . FILTER(LANG(?sComment) = "de") }
  OPTIONAL { ?s :hierarchyLevel ?hierarchyLevel }

  OPTIONAL {
    ?s schema:hasPart ?subGroup .
    OPTIONAL { ?subGroup rdfs:label   ?subGroupLabel   . FILTER(LANG(?subGroupLabel)   = "de") }
    OPTIONAL { ?subGroup rdfs:comment ?subGroupComment . FILTER(LANG(?subGroupComment) = "de") }
  }

  OPTIONAL { ?s schema:isPartOf ?superGroup }

  OPTIONAL {
    ?s :includesInspectionPoints ?inspectionPoint .
    OPTIONAL { ?inspectionPoint rdfs:label   ?inspectionPointLabel   . FILTER(LANG(?inspectionPointLabel)   = "de") }
    OPTIONAL { ?inspectionPoint rdfs:comment ?inspectionPointComment . FILTER(LANG(?inspectionPointComment) = "de") }
  }

  OPTIONAL { ?s :belongsToGroup ?parentGroup }
}`;

      /**
       * Fetch data from the SPARQL endpoint.
       * @returns {Promise<any[]>} Array of SPARQL bindings
       */
      async function fetchBindings() {
        const response = await fetch(ENDPOINT, {
          method: "POST",
          headers: {
            "Content-Type": "application/sparql-query",
            Accept: "application/sparql-results+json",
          },
          body: SPARQL_QUERY,
        });
        if (!response.ok) {
          throw new Error(`SPARQL request failed: ${response.statusText}`);
        }
        const json = await response.json();
        return json.results.bindings;
      }

      /**
       * Build a node map keyed by URI.
       */
      function buildNodeMap(bindings) {
        const map = new Map();

        function ensure(uri) {
          if (!map.has(uri)) {
            map.set(uri, {
              id: uri,
              type: null,
              label: null,
              comment: null,
              hierarchyLevel: null,
              subGroups: new Set(),
              inspectionPoints: new Set(),
              superGroup: null,
              parentGroup: null,
            });
          }
          return map.get(uri);
        }

        bindings.forEach((b) => {
          const s = ensure(b.s.value);
          s.type = b.sType.value.endsWith("Collection") ? "collection" : "inspection";
          if (b.sLabel) s.label = b.sLabel.value;
          if (b.sComment) s.comment = b.sComment.value;
          if (b.hierarchyLevel) s.hierarchyLevel = b.hierarchyLevel.value;
          if (b.subGroup) {
            s.subGroups.add(b.subGroup.value);
            const sg = ensure(b.subGroup.value);
            if (b.subGroupLabel) sg.label = b.subGroupLabel.value;
            if (b.subGroupComment) sg.comment = b.subGroupComment.value;
            sg.type = "collection";
          }
          if (b.superGroup) s.superGroup = b.superGroup.value;
          if (b.parentGroup) s.parentGroup = b.parentGroup.value;
          if (b.inspectionPoint) {
            s.inspectionPoints.add(b.inspectionPoint.value);
            const ip = ensure(b.inspectionPoint.value);
            ip.type = "inspection";
            if (b.inspectionPointLabel) ip.label = b.inspectionPointLabel.value;
            if (b.inspectionPointComment) ip.comment = b.inspectionPointComment.value;
          }
        });

        return map;
      }

      /**
       * Build hierarchical tree for jsTree.
       */
      function buildTree(map) {
        // Roots: collections without superGroup or parentGroup
        const roots = [...map.values()].filter(
          (n) =>
            n.type === "collection" &&
            n.superGroup === null &&
            n.parentGroup === null
        );

        function rec(node) {
          // Collection children: subGroups + inspectionPoints
          const children = [];
          node.subGroups.forEach((uri) => {
            children.push(rec(map.get(uri)));
          });
          node.inspectionPoints.forEach((uri) => {
            children.push(rec(map.get(uri)));
          });

          return {
            id: node.id,
            text: node.label || uriLocalName(node.id),
            icon:
              node.type === "collection"
                ? "bi bi-collection"
                : "bi bi-crosshair",
            data: {
              comment: node.comment || "",
              hierarchyLevel: node.hierarchyLevel || "",
              type: node.type,
            },
            children,
          };
        }

        return roots.map(rec);
      }

      /** Extract local name after last slash */
      function uriLocalName(uri) {
        return uri.split("/").slice(-1)[0];
      }

      /**
       * Build Lunr search index.
       */
      function buildSearchIndex(map) {
        return lunr(function () {
          this.ref("id");
          this.field("label");
          this.field("comment");

          for (const node of map.values()) {
            this.add({ id: node.id, label: node.label || "", comment: node.comment || "" });
          }
        });
      }

      /**
       * Initialize jsTree widget.
       */
      function initJsTree(treeData) {
        $("#tree").jstree("destroy");
        $("#tree").jstree({
          core: {
            data: treeData,
            themes: { dots: true },
          },
          plugins: ["search"],
        });
      }

      /**
       * Display details of a selected node.
       */
      function showDetails(node) {
        const { label, comment, hierarchyLevel, type } = node.data;
        $("#details").html(`
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">
                <i class="${node.icon}"></i> ${label}
              </h5>
              ${comment ? `<p class="card-text">${comment}</p>` : ""}
              ${hierarchyLevel ? `<span class="badge bg-secondary">Level ${hierarchyLevel}</span>` : ""}
              <span class="badge bg-info">${type === "collection" ? "Gruppe" : "Kontrollpunkt"}</span>
            </div>
          </div>
        `);
      }

      /**
       * Main app bootstrap
       */
      async function bootstrap() {
        try {
          $("#tree").text("Lade Daten…");
          const bindings = await fetchBindings();
          const nodeMap = buildNodeMap(bindings);
          const treeData = buildTree(nodeMap);
          const searchIndex = buildSearchIndex(nodeMap);

          initJsTree(treeData);

          // Selection event
          $("#tree").on("select_node.jstree", function (e, data) {
            showDetails(data.node);
          });

          // Search event (debounced)
          let timeout = null;
          $("#search").on("input", function () {
            clearTimeout(timeout);
            const query = this.value.trim();
            timeout = setTimeout(() => {
              if (query === "") {
                $("#tree").jstree(true).search("");
              } else {
                const ids = searchIndex.search(query + "*").map((r) => r.ref);
                // custom search: highlight matching ids
                $("#tree").jstree(true).search(() => false); // reset
                $("#tree").jstree(true).select_node(ids);
              }
            }, 300);
          });

          // Expand to root nodes initially
          $("#tree").jstree("open_all");
        } catch (err) {
          console.error(err);
          $("#tree").html(
            `<div class="alert alert-danger">Fehler beim Laden der Daten: ${err.message}</div>`
          );
        }
      }

      bootstrap();
    </script>
  </body>
</html>